---
- hosts: all
  become: yes
  tasks:
  - name: set hostname. the hostname is {{inventory_hostname}}
    template:
      src: hostname.j2
      dest: /etc/hostname
  - name: Execute reboot when kernel has changed
    shell: sleep 5 && reboot
    async: 1
    ignore_errors: true
    register: reboot
  - name: Wait for servers reboot task to execute
    pause:
     seconds: 40
    when: reboot is defined
  - name: Wait for provisioned server
    delegate_to: localhost
    wait_for:
     host: "{{ inventory_hostname }}"
     port: 22
     state: started
     timeout: 300
     connect_timeout: 20
    when: reboot is defined
 # important
 # playbook command with sudo
 # sudo ansible-playbook --user root -i data/myansible/inventory data/myansible/testset_hostname.yaml -l deb03.localdomain -c paramiko -vvvv
 # the inventory settings must be in /etc/ansible/hosts
